<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disposition Sc√©nique - Arnisound Tools</title>
    
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                              ‚ïë
‚ïë                    DISPOSITION SC√âNIQUE v1.0                                 ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Copyright ¬© 2025 Th√©o Arnisound                                            ‚ïë
‚ïë  Tous droits r√©serv√©s                                                       ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Module de liaison Fiche Tech Creator ‚Üí Stage Plan                          ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #000000 0%, #ffffff 300%);
            color: white;
            padding: 45px 45px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header svg {
            max-width: 100%;
            height: auto;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #c19a3e 0%, #ffd700 100%);
            height: 100%;
            width: 100%;
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px 30px;
        }

        .info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #c19a3e;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .info-box h3 {
            color: #c19a3e;
            margin-bottom: 15px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #333;
        }

        .info-box li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .grouping-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #c19a3e;
        }

        .table-wrapper {
            overflow-x: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .grouping-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .grouping-table thead {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .grouping-table th {
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
            border: 1px solid #444;
            font-size: 14px;
        }

        .grouping-table td {
            padding: 12px 10px;
            border: 1px solid #ddd;
            text-align: center;
            background: white;
        }

        .grouping-table tbody tr:hover {
            background: #f8f9fa;
        }

        .grouping-table tbody tr.has-group {
            background: #fff3cd;
        }

        .channel-cell {
            background: #c19a3e;
            color: #000;
            font-weight: bold;
            font-size: 14px;
        }

        .instrument-cell {
            text-align: left;
            padding-left: 15px;
            font-weight: 500;
            color: #333;
        }

        .mic-cell {
            text-align: left;
            color: #666;
            font-size: 13px;
        }

        .checkbox-cell {
            padding: 5px;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #c19a3e;
        }

        .position-cell select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .position-cell select:focus {
            outline: none;
            border-color: #c19a3e;
            box-shadow: 0 0 0 2px rgba(193, 154, 62, 0.2);
        }

        .position-cell select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .options-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .option-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: #c19a3e;
            box-shadow: 0 2px 8px rgba(193, 154, 62, 0.2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .checkbox-label input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #c19a3e;
        }

        .option-description {
            margin: 10px 0 0 34px;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #c19a3e 0%, #ffd700 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(193, 154, 62, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-add-group {
            background: white;
            border: 2px solid #c19a3e;
            color: #c19a3e;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-add-group:hover {
            background: #c19a3e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 154, 62, 0.3);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .summary-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .summary-title {
            font-size: 20px;
            color: #2e7d32;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #c19a3e;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* ---- Section sc√®ne ---- */
        .stage-section { margin-bottom: 40px; }

        .stage-legend {
            background: #f8f9fa;
            border-left: 4px solid #c19a3e;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 7px;
        }
        .legend-item { font-size: 0.88em; color: #444; line-height: 1.4; }
        .legend-icon { font-size: 1.1em; }

        .stage-wrapper { display: flex; flex-direction: column; align-items: stretch; gap: 8px; }

        .stage-top-label, .stage-bottom-label {
            font-weight: bold; text-align: center;
            padding: 10px 24px; border-radius: 8px;
            font-size: 14px; letter-spacing: 0.5px;
        }
        .stage-top-label { background: #1a1a2e; color: #c19a3e; }
        .stage-bottom-label { background: #1a3a1a; color: #4caf50; }

        .stage-outer { display: flex; align-items: stretch; gap: 8px; }

        .side-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.72em; font-weight: bold; text-align: center;
            padding: 10px 6px; border-radius: 8px; white-space: nowrap;
            display: flex; align-items: center; justify-content: center;
        }
        .side-label.jardin {
            transform: rotate(180deg);
            background: #e8eaf6; color: #3949ab;
        }
        .side-label.cour { background: #fce4ec; color: #c62828; }

        /* ---- Grille 7√ó5 ---- */
        .stage-grid-container { flex: 1; display: flex; flex-direction: column; gap: 4px; overflow-x: auto; }

        .stage-grid-header, .stage-row {
            display: grid;
            grid-template-columns: 58px repeat(7, 1fr);
            gap: 4px;
            min-width: 600px;
        }

        .corner-cell { /* espace vide en haut √† gauche */ }

        .col-header {
            text-align: center; font-size: 0.7em; color: #888;
            padding: 4px 2px; border-bottom: 2px solid #ddd;
            font-weight: 600;
        }

        .row-header {
            display: flex; align-items: center; justify-content: flex-end;
            font-size: 0.7em; color: #888; padding-right: 8px;
            border-right: 2px solid #ddd; font-weight: 600;
        }

        .stage-cell {
            background: #fafafa;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            min-height: 75px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 5px; padding: 6px;
            transition: border-color 0.2s, background 0.2s;
        }
        .stage-cell:hover { border-color: #c19a3e; background: #fff9f0; }
        .stage-cell.has-group { border-color: #4caf50; background: #f1f8f1; }

        .cell-groups {
            display: flex; flex-wrap: wrap; gap: 4px;
            justify-content: center; width: 100%;
        }

        .group-chip {
            display: flex; align-items: center; gap: 3px;
            padding: 3px 8px; border-radius: 12px;
            font-size: 0.72em; font-weight: bold; color: #fff;
            max-width: 100%; overflow: hidden;
        }
        .group-chip .chip-remove {
            cursor: pointer; opacity: 0.7; margin-left: 2px; flex-shrink: 0;
        }
        .group-chip .chip-remove:hover { opacity: 1; }

        .cell-add-btn {
            background: transparent;
            border: 1px dashed #ccc;
            color: #aaa; border-radius: 6px;
            padding: 2px 10px; cursor: pointer;
            font-size: 1em; line-height: 1.6;
            transition: all 0.2s;
        }
        .cell-add-btn:hover { border-color: #c19a3e; color: #c19a3e; }

        /* ---- Modal ---- */
        .modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #fff; border: 2px solid #c19a3e;
            border-radius: 16px; padding: 28px; min-width: 300px; max-width: 420px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        .modal-content h4 { color: #c19a3e; margin-bottom: 16px; font-size: 1.15em; }
        .group-picker-item {
            display: flex; align-items: center; gap: 10px;
            padding: 11px; border-radius: 8px; cursor: pointer;
            transition: background 0.2s; color: #333;
            border: 1px solid transparent;
        }
        .group-picker-item:hover { background: #fff9f0; border-color: #c19a3e; }
        .group-picker-item.already-here { opacity: 0.45; cursor: default; }
        .group-picker-no-active { color: #888; font-size: 0.9em; padding: 10px 0; }
        .btn-cancel {
            margin-top: 14px; background: #f0f0f0; color: #666;
            border: none; border-radius: 8px; padding: 9px 20px;
            cursor: pointer; font-size: 0.95em; width: 100%;
        }
        .btn-cancel:hover { background: #e0e0e0; }

        .position-cell select { display: none; } /* masquer l'ancien select si pr√©sent */

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
        /* ---- Export buttons in disposition-scenique ---- */
        .export-btns-row {
            display: flex;
            gap: 10px;
            margin-top: 0;
        }
        .btn-export-scene {
            flex: 1;
            padding: 12px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.88em;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #ffa500 0%, #ffd700 100%);
            color: #1a1a1a;
            transition: all 0.2s ease;
        }
        .btn-export-scene:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(255,165,0,0.4);
        }
        .btn-export-scene.btn-png {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
        }
        .btn-export-scene.btn-png:hover {
            box-shadow: 0 4px 14px rgba(106,17,203,0.4);
        }
        .export-hint {
            font-size: 0.78em;
            color: #999;
            text-align: center;
            margin-top: 8px;
        }
        /* ------------------------------------------------ */

        /* ---- Section exports structur√©e ---- */
        .export-section {
            margin-top: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 16px;
            padding: 22px 18px 16px;
        }
        .export-section-title {
            color: #ffd700;
            font-size: 1.1em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: 0.04em;
        }
        .export-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 0;
        }
        .export-category {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,215,0,0.18);
            border-radius: 12px;
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .export-category-label {
            color: #e0e0e0;
            font-weight: 600;
            font-size: 0.82em;
            text-align: center;
        }
        .export-category-buttons {
            display: flex;
            gap: 6px;
        }
        .btn-export {
            flex: 1;
            padding: 9px 4px;
            border: none;
            border-radius: 8px;
            font-size: 0.80em;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #ffa500 0%, #ffd700 100%);
            color: #1a1a1a;
            transition: all 0.2s ease;
            letter-spacing: 0.02em;
        }
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(255,165,0,0.45);
        }
        .btn-export.btn-csv {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: #fff;
        }
        .btn-export.btn-csv:hover {
            box-shadow: 0 4px 14px rgba(17,153,142,0.45);
        }
        @media (max-width: 660px) {
            .export-categories { grid-template-columns: 1fr; }
        }
        /* ------------------------------------------------ */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <svg width="1000" height="200" viewBox="0 0 1600 320" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                    <!-- Cercle blanc -->
                    <circle cx="400" cy="160" r="140" fill="none" stroke="#FFFFFF" stroke-width="12"/>
                    <!-- Texte FICHE TECH -->
                    <text x="400" y="140" fill="#FFFFFF" font-family="Arial, Helvetica, sans-serif" font-weight="bold" font-size="36" text-anchor="middle" letter-spacing="3">FICHE TECH</text>
                    <!-- Texte CREATOR -->
                    <text x="400" y="185" fill="#FFFFFF" font-family="Arial, Helvetica, sans-serif" font-weight="bold" font-size="36" text-anchor="middle" letter-spacing="3">CREATOR</text>
                    <!-- Forme d'onde dor√©e -->
                    <path d="M 330 250 C 338 250, 343 247, 348 243 C 353 239, 358 247, 363 250 C 368 253, 373 254, 378 253 C 383 252, 388 243, 396 237 C 404 231, 409 237, 414 243 C 419 249, 424 253, 429 254 C 434 255, 439 254, 444 253 C 449 252, 454 250, 459 250.5 C 464 251, 466.5 251.5, 469 252" fill="none" stroke="#C19A3E" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <!-- Groupe texte ARNISOUND TOOLS -->
                    <g transform="translate(1050, 0)">
                        <text x="0" y="100" fill="#FFFFFF" font-family="Arial, Helvetica, sans-serif" font-weight="bold" font-size="38" text-anchor="middle" letter-spacing="2">ARNISOUND</text>
                        <text x="0" y="145" fill="#FFFFFF" font-family="Arial, Helvetica, sans-serif" font-weight="bold" font-size="38" text-anchor="middle" letter-spacing="3">TOOLS</text>
                        <text x="0" y="190" fill="#FFFFFF" font-family="Arial, Helvetica, sans-serif" font-weight="bold" font-size="38" text-anchor="middle" letter-spacing="3">LIVE &amp; AV</text>
                        <text x="0" y="235" fill="#FFFFFF" font-family="Arial, Helvetica, sans-serif" font-weight="bold" font-size="38" text-anchor="middle" letter-spacing="3">APP</text>
                    </g>
                </svg>
                <p style="color: white; font-size: 1.1em; margin-top: 15px; margin-bottom: 0; opacity: 0.95; text-align: center;">Organisez votre configuration sc√©nique avant de g√©n√©rer le plan</p>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>

        <div class="content">
            <!-- Alerte si pas de donn√©es -->
            <div id="noDataAlert" class="alert alert-warning" style="display: none;">
                <strong>‚ö†Ô∏è Aucune donn√©e d√©tect√©e</strong><br>
                Veuillez d'abord compl√©ter le questionnaire dans <strong>Fiche Tech Creator</strong> pour g√©n√©rer votre patch list.
                <div style="margin-top: 15px;">
                    <a href="fiche-tech-creator-v2.html" class="btn btn-secondary">‚Üê Retour √† Fiche Tech Creator</a>
                </div>
            </div>

            <!-- Contenu principal -->
            <div id="mainContent" style="display: none;">
                <!-- Instructions -->
                <div class="info-box">
                    <h3>üìã Comment √ßa fonctionne :</h3>
                    <ul>
                        <li><strong>√âtape 1 :</strong> Pour chaque piste, cochez le groupe de retour correspondant (Musicien 1, Musicien 2, etc.)</li>
                        <li><strong>√âtape 2 :</strong> Sur le tableau de sc√®ne ci-dessous, cliquez <strong>Ôºã</strong> dans une cellule pour y placer un groupe</li>
                        <li><strong>√âtape 3 :</strong> Configurez les options de g√©n√©ration automatique</li>
                        <li><strong>√âtape 4 :</strong> G√©n√©rez votre plan de sc√®ne</li>
                    </ul>
                </div>

                <!-- R√©sum√© du patch -->
                <div id="summaryBox" class="summary-box" style="display: none;">
                    <div class="summary-title">üìä R√©sum√© de votre configuration</div>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalTracks">0</div>
                            <div class="stat-label">Pistes totales</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="assignedTracks">0</div>
                            <div class="stat-label">Pistes assign√©es</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="activeGroups">0</div>
                            <div class="stat-label">Groupes actifs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stageZones">0</div>
                            <div class="stat-label">Zones utilis√©es</div>
                        </div>
                    </div>
                </div>

                <!-- Tableau de groupement -->
                <div class="grouping-section">
                    <h2 class="section-title">üéº Groupement des pistes</h2>
                    
                    <div class="table-wrapper">
                        <table class="grouping-table">
                            <thead>
                                <tr id="tableHeader">
                                    <th style="width: 60px;">Canal</th>
                                    <th style="width: 250px;">Instrument</th>
                                    <th style="width: 200px;">Microphone</th>
                                    <!-- Colonnes de groupe g√©n√©r√©es dynamiquement depuis la Patch List Retours -->
                                </tr>
                            </thead>
                            <tbody id="groupingTableBody">
                                <!-- Sera rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>

                    <button class="btn-add-group" onclick="addCustomGroup()">+ Ajouter un groupe personnalis√©</button>
                </div>

                <!-- Tableau de sc√®ne 7x5 -->
                <div class="stage-section">
                    <h2 class="section-title">üé≠ Disposition sur sc√®ne</h2>

                    <div class="stage-legend">
                        <div class="legend-item"><span class="legend-icon">üé≠</span> <strong>Fond de sc√®ne (Upstage)</strong> ‚Äî rang√©e 1 en haut, dos au public</div>
                        <div class="legend-item"><span class="legend-icon">üé§</span> <strong>Devant de sc√®ne (Downstage)</strong> ‚Äî rang√©e 5 en bas, c√¥t√© public</div>
                        <div class="legend-item"><span class="legend-icon">üåø</span> <strong>Jardin</strong> ‚Äî c√¥t√© gauche vu du public (droite pour les musiciens sur sc√®ne)</div>
                        <div class="legend-item"><span class="legend-icon">‚öñÔ∏è</span> <strong>Cour</strong> ‚Äî c√¥t√© droit vu du public (gauche pour les musiciens sur sc√®ne)</div>
                        <div class="legend-item">üí° Assignez d'abord les pistes aux groupes dans le tableau ci-dessus, puis cliquez <strong>Ôºã</strong> dans une cellule pour y placer un groupe.</div>
                    </div>

                    <div class="stage-wrapper">
                        <div class="stage-top-label">üé≠ FOND DE SC√àNE ‚Äî Upstage</div>
                        <div class="stage-outer">
                            <div class="side-label jardin">üåø JARDIN<br>(gauche public)</div>
                            <div id="stageGrid" class="stage-grid-container"></div>
                            <div class="side-label cour">‚öñÔ∏è COUR<br>(droite public)</div>
                        </div>
                        <div class="stage-bottom-label">üé§ DEVANT ‚Äî Public</div>
                    </div>
                </div>

                <!-- Modal picker de groupe -->
                <div id="groupPickerModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <h4>Placer un groupe ici</h4>
                        <div id="groupPickerList"></div>
                        <button class="btn-cancel" onclick="closeGroupPicker()">Annuler</button>
                    </div>
                </div>

                <!-- Options de g√©n√©ration -->
                <div class="options-section" style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 16px; font-size: 18px;">‚öôÔ∏è Options de g√©n√©ration automatique</h3>
                    <div class="options-grid">
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateReturns" checked>
                                <span>üîä Retours / Wedges</span>
                            </label>
                            <p class="option-description">Inclure les retours de sc√®ne (wedges, IEM, etc.)</p>
                        </div>
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateDI" checked>
                                <span>üì¶ Bo√Ætes DI</span>
                            </label>
                            <p class="option-description">Afficher les bo√Ætes DI pour les instruments</p>
                        </div>
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateAmpli" checked>
                                <span>üîå Amplis</span>
                            </label>
                            <p class="option-description">Inclure les amplificateurs sur le plan</p>
                        </div>
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateMicrophones" checked>
                                <span>üéôÔ∏è Microphones</span>
                            </label>
                            <p class="option-description">Afficher les microphones assign√©s</p>
                        </div>
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateCables" checked>
                                <span>üîó C√¢bles</span>
                            </label>
                            <p class="option-description">Indiquer les c√¢bles de liaison</p>
                        </div>
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoScale" checked>
                                <span>üìê Mise √† l'√©chelle auto</span>
                            </label>
                            <p class="option-description">Ajuster automatiquement la taille du plan</p>
                        </div>
                    </div>
                </div>

                <!-- Astuce g√©n√©ration rapide -->
                <div style="background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%); border-left: 4px solid #c19a3e; border-radius: 8px; padding: 16px 20px; margin-bottom: 24px;">
                    <p style="margin: 0; color: #5a4a00; font-size: 0.95em; line-height: 1.6;">
                        <span style="font-size: 1.1em; margin-right: 6px;">üí°</span>
                        <strong>Astuce :</strong> cette g√©n√©ration rapide permet d'avoir une fiche technique compr√©hensible en quelques secondes. Par la suite, vous pourrez utiliser la banque d'images et les outils pour faire un plan de sc√®ne plus esth√©tique.
                    </p>
                </div>

                <!-- Boutons de navigation -->
                <div class="buttons">
                    <a href="fiche-tech-creator-v2.html" class="btn btn-secondary">
                        ‚Üê Retour au questionnaire
                    </a>
                    <button class="btn btn-primary" onclick="generateAndOpenStagePlan()">
                        G√©n√©rer le plan de sc√®ne ‚Üí
                    </button>
                </div>

                <!-- Section exports structur√©e -->
                <div class="export-section" id="exportSceneBlock">
                    <div class="export-section-title">üì§ Exporter</div>
                    <div class="export-categories">

                        <div class="export-category">
                            <div class="export-category-label">üìã Fiche technique compl√®te</div>
                            <div class="export-category-buttons">
                                <button class="btn-export" onclick="exportFicheTechPDF()" title="T√©l√©charger la fiche compl√®te en PDF">üìÑ PDF</button>
                                <button class="btn-export" onclick="exportFicheTechPNG()" title="T√©l√©charger la fiche compl√®te en PNG">üñºÔ∏è PNG</button>
                            </div>
                        </div>

                        <div class="export-category">
                            <div class="export-category-label">üéõÔ∏è Patch list</div>
                            <div class="export-category-buttons">
                                <button class="btn-export" onclick="exportPatchListPDF()" title="T√©l√©charger la patch list en PDF">üìÑ PDF</button>
                                <button class="btn-export btn-csv" onclick="exportPatchListCSV()" title="T√©l√©charger la patch list en CSV (Excel)">üìä CSV</button>
                            </div>
                        </div>

                        <div class="export-category">
                            <div class="export-category-label">üé≠ Plan de sc√®ne</div>
                            <div class="export-category-buttons">
                                <button class="btn-export" onclick="exportScenePlanPDF()" title="Exporter le plan de sc√®ne en PDF">üìÑ PDF</button>
                                <button class="btn-export" onclick="exportScenePlanPNG()" title="Exporter le plan de sc√®ne en PNG">üñºÔ∏è PNG</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let patchList = [];
        let returnsList = [];
        let groupColumns = [];
        let groupIcons = {};
        let groupNames = {};
        let groupColors = {};

        // Colonnes de secours si pas de returnsList disponible
        const defaultGroupColumns = ['batterie', 'guitare', 'basse', 'clavier', 'voix', 'choeurs'];
        const defaultGroupIcons = {
            'batterie': 'ü•Å',
            'guitare': 'üé∏',
            'basse': 'üé∏',
            'clavier': 'üéπ',
            'voix': 'üé§',
            'choeurs': 'üéµ'
        };
        const defaultGroupNames = {
            'batterie': 'Batterie',
            'guitare': 'Guitare',
            'basse': 'Basse',
            'clavier': 'Clavier',
            'voix': 'Voix Lead',
            'choeurs': 'Ch≈ìurs'
        };

        // Construire les colonnes dynamiques depuis la patch list retours
        function buildDynamicColumns() {
            groupColumns = [];
            groupIcons = {};
            groupNames = {};
            groupColors = {};

            const typeIcons = {
                'Wedge': 'üîä',
                'IEM Mono': 'üéß',
                'IEM St√©r√©o': 'üéß',
                'Link Mono': 'üì¢',
                'St√©r√©o': 'üì¢'
            };

            returnsList.forEach(retour => {
                const id = `retour_${retour.aux}`;
                groupColumns.push(id);
                groupIcons[id] = typeIcons[retour.type] || 'üîä';
                groupNames[id] = retour.destination || `AUX ${retour.aux}`;
                groupColors[id] = retour.color || '#888888';
            });
        }

        // G√©n√©rer les en-t√™tes de colonnes dynamiquement
        function updateTableHeaders() {
            const headerRow = document.getElementById('tableHeader');
            // Garder les 3 premi√®res colonnes fixes (Canal, Instrument, Microphone)
            const ths = Array.from(headerRow.children);
            for (let i = ths.length - 1; i >= 3; i--) {
                headerRow.removeChild(ths[i]);
            }
            // Ajouter les colonnes dynamiques (noms de destination des retours)
            groupColumns.forEach(groupId => {
                const th = document.createElement('th');
                th.style.borderBottom = `3px solid ${groupColors[groupId] || '#cccccc'}`;
                th.innerHTML = `${groupIcons[groupId]} ${groupNames[groupId]}`;
                th.title = groupId.startsWith('retour_') ? `AUX ${groupId.replace('retour_', '')}` : groupId;
                headerRow.appendChild(th);
            });
        }

        // Charger les donn√©es au d√©marrage
        window.addEventListener('DOMContentLoaded', function() {
            loadPatchData();
        });

        // Charger les donn√©es du patch depuis localStorage
        function loadPatchData() {
            try {
                const storedData = localStorage.getItem('patchList');
                const storedReturns = localStorage.getItem('returnsList');

                // Charger returnsList et construire les colonnes dynamiques
                if (storedReturns && storedReturns !== 'null' && storedReturns !== '[]') {
                    returnsList = JSON.parse(storedReturns);
                    if (returnsList && returnsList.length > 0) {
                        buildDynamicColumns();
                    }
                }

                // Utiliser les colonnes par d√©faut si pas de returnsList
                if (groupColumns.length === 0) {
                    groupColumns = [...defaultGroupColumns];
                    groupIcons = { ...defaultGroupIcons };
                    groupNames = { ...defaultGroupNames };
                }

                updateTableHeaders();
                buildStageGrid();

                if (storedData && storedData !== 'null' && storedData !== '[]') {
                    patchList = JSON.parse(storedData);

                    if (patchList && patchList.length > 0) {
                        document.getElementById('noDataAlert').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                        initializeTable();
                        updateSummary();
                    } else {
                        showNoDataAlert();
                    }
                } else {
                    showNoDataAlert();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                showNoDataAlert();
            }
        }

        // Afficher l'alerte "pas de donn√©es"
        function showNoDataAlert() {
            document.getElementById('noDataAlert').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        // Initialiser le tableau
        function initializeTable() {
            const tbody = document.getElementById('groupingTableBody');
            tbody.innerHTML = '';

            patchList.forEach((track, index) => {
                const row = document.createElement('tr');
                row.dataset.trackIndex = index;

                // Canal
                const channelCell = document.createElement('td');
                channelCell.className = 'channel-cell';
                channelCell.textContent = track.channel;
                row.appendChild(channelCell);

                // Instrument
                const instrumentCell = document.createElement('td');
                instrumentCell.className = 'instrument-cell';
                instrumentCell.textContent = track.instrument || track.name || '-';
                row.appendChild(instrumentCell);

                // Microphone
                const micCell = document.createElement('td');
                micCell.className = 'mic-cell';
                micCell.textContent = track.mic || track.microphone || '-';
                row.appendChild(micCell);

                // Checkboxes pour chaque groupe
                groupColumns.forEach(groupId => {
                    const checkCell = document.createElement('td');
                    checkCell.className = 'checkbox-cell';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.trackIndex = index;
                    checkbox.dataset.group = groupId;
                    checkbox.addEventListener('change', handleGroupChange);
                    
                    checkCell.appendChild(checkbox);
                    row.appendChild(checkCell);
                });

                tbody.appendChild(row);
            });
        }

        // G√©rer le changement de checkbox
        function handleGroupChange(e) {
            const checkbox = e.target;
            const groupId = checkbox.dataset.group;
            const row = checkbox.closest('tr');

            if (checkbox.checked) {
                // D√©cocher les autres checkboxes de cette ligne
                row.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb !== checkbox) {
                        // Si un autre groupe √©tait coch√©, le retirer de la sc√®ne
                        if (cb.checked) removeGroupFromPosition(cb.dataset.group);
                        cb.checked = false;
                    }
                });
                row.classList.add('has-group');
            } else {
                // Retirer le groupe de sa position sur la sc√®ne
                removeGroupFromPosition(groupId);
                row.classList.remove('has-group');
            }

            updateSummary();
        }

        // Mettre √† jour le r√©sum√©
        function updateSummary() {
            const tbody = document.getElementById('groupingTableBody');
            const rows = Array.from(tbody.rows);

            const totalTracks = patchList.length;
            let assignedTracks = 0;
            const activeGroupsSet = new Set();

            rows.forEach(row => {
                const checkedBox = row.querySelector('input[type="checkbox"]:checked');
                if (checkedBox) {
                    assignedTracks++;
                    activeGroupsSet.add(checkedBox.dataset.group);
                }
            });

            // Compter les zones de sc√®ne utilis√©es depuis groupPositions
            const stageZonesSet = new Set(Object.values(groupPositions));

            document.getElementById('totalTracks').textContent = totalTracks;
            document.getElementById('assignedTracks').textContent = assignedTracks;
            document.getElementById('activeGroups').textContent = activeGroupsSet.size;
            document.getElementById('stageZones').textContent = stageZonesSet.size;

            // Afficher le r√©sum√© si des pistes sont assign√©es
            document.getElementById('summaryBox').style.display = assignedTracks > 0 ? 'block' : 'none';
        }

        // Ajouter un groupe personnalis√©
        function addCustomGroup() {
            const groupName = prompt('Nom du groupe personnalis√©:');
            if (!groupName) return;
            
            const groupId = groupName.toLowerCase().replace(/\s+/g, '-');
            if (groupColumns.includes(groupId)) {
                alert('Ce groupe existe d√©j√†!');
                return;
            }
            
            const icon = prompt('Emoji pour le groupe (optionnel):', 'üéµ');
            
            groupColumns.push(groupId);
            groupIcons[groupId] = icon || 'üéµ';
            groupNames[groupId] = groupName;
            
            // Ajouter la colonne dans le header
            const thead = document.querySelector('.grouping-table thead tr');
            const newTh = document.createElement('th');
            newTh.textContent = `${icon || 'üéµ'} ${groupName}`;
            thead.appendChild(newTh);

            // Ajouter la checkbox dans chaque ligne
            const tbody = document.getElementById('groupingTableBody');
            Array.from(tbody.rows).forEach((row, index) => {
                const checkCell = document.createElement('td');
                checkCell.className = 'checkbox-cell';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.trackIndex = index;
                checkbox.dataset.group = groupId;
                checkbox.addEventListener('change', handleGroupChange);

                checkCell.appendChild(checkbox);
                row.appendChild(checkCell);
            });
        }

        // ============================================================
        // GRILLE DE SC√àNE 7√ó5
        // ============================================================

        // Stockage des positions : { groupId: positionId }
        let groupPositions = {};
        let currentPickerPosition = null;

        const STAGE_ROWS = [
            { id: 'r1', label: 'Fond' },
            { id: 'r2', label: 'Arri√®re' },
            { id: 'r3', label: 'Milieu' },
            { id: 'r4', label: 'Avant' },
            { id: 'r5', label: 'Devant' }
        ];
        const STAGE_COLS = [
            { id: 'j2', label: 'J.Ext',  title: 'Jardin extr√™me' },
            { id: 'j1', label: 'Jardin', title: 'Jardin' },
            { id: 'jc', label: 'J.Ctr',  title: 'Jardin centre' },
            { id: 'c',  label: 'Centre', title: 'Centre' },
            { id: 'cc', label: 'C.Ctr',  title: 'Cour centre' },
            { id: 'c1', label: 'Cour',   title: 'Cour' },
            { id: 'c2', label: 'C.Ext',  title: 'Cour extr√™me' }
        ];

        function buildStageGrid() {
            const grid = document.getElementById('stageGrid');
            grid.innerHTML = '';

            // Ligne d'en-t√™te des colonnes
            const headerRow = document.createElement('div');
            headerRow.className = 'stage-grid-header';
            const corner = document.createElement('div');
            corner.className = 'corner-cell';
            headerRow.appendChild(corner);
            STAGE_COLS.forEach(col => {
                const th = document.createElement('div');
                th.className = 'col-header';
                th.textContent = col.label;
                th.title = col.title;
                headerRow.appendChild(th);
            });
            grid.appendChild(headerRow);

            // Lignes de cellules
            STAGE_ROWS.forEach(row => {
                const rowEl = document.createElement('div');
                rowEl.className = 'stage-row';

                const rowLabel = document.createElement('div');
                rowLabel.className = 'row-header';
                rowLabel.textContent = row.label;
                rowEl.appendChild(rowLabel);

                STAGE_COLS.forEach(col => {
                    const posId = `${row.id}_${col.id}`;
                    const cell = document.createElement('div');
                    cell.className = 'stage-cell';
                    cell.dataset.position = posId;

                    const cellGroups = document.createElement('div');
                    cellGroups.className = 'cell-groups';
                    cellGroups.id = `cell-${posId}`;

                    const addBtn = document.createElement('button');
                    addBtn.className = 'cell-add-btn';
                    addBtn.textContent = 'Ôºã';
                    addBtn.onclick = () => showGroupPicker(posId);

                    cell.appendChild(cellGroups);
                    cell.appendChild(addBtn);
                    rowEl.appendChild(cell);
                });
                grid.appendChild(rowEl);
            });
        }

        // Ouvrir le modal pour choisir un groupe √† placer dans une cellule
        function showGroupPicker(position) {
            currentPickerPosition = position;
            const list = document.getElementById('groupPickerList');
            list.innerHTML = '';

            const activeGroups = getActiveGroups();

            if (activeGroups.length === 0) {
                const msg = document.createElement('p');
                msg.className = 'group-picker-no-active';
                msg.textContent = 'Aucun groupe actif. Cochez d\'abord des pistes dans le tableau.';
                list.appendChild(msg);
            } else {
                activeGroups.forEach(groupId => {
                    const alreadyHere = groupPositions[groupId] === position;
                    const item = document.createElement('div');
                    item.className = 'group-picker-item' + (alreadyHere ? ' already-here' : '');

                    const dot = document.createElement('span');
                    dot.style.cssText = `background:${groupColors[groupId] || '#888'};width:14px;height:14px;border-radius:50%;display:inline-block;flex-shrink:0;`;

                    const label = document.createElement('span');
                    label.textContent = `${groupIcons[groupId] || ''} ${groupNames[groupId] || groupId}`;

                    item.appendChild(dot);
                    item.appendChild(label);

                    if (alreadyHere) {
                        const badge = document.createElement('span');
                        badge.style.cssText = 'color:#4caf50;font-size:0.85em;margin-left:auto;';
                        badge.textContent = '‚úì D√©j√† ici';
                        item.appendChild(badge);
                    } else {
                        item.onclick = () => assignGroupToPosition(groupId, position);
                    }
                    list.appendChild(item);
                });
            }

            document.getElementById('groupPickerModal').style.display = 'flex';
        }

        function closeGroupPicker() {
            document.getElementById('groupPickerModal').style.display = 'none';
            currentPickerPosition = null;
        }

        function assignGroupToPosition(groupId, position) {
            // Retirer le groupe de son ancienne position si n√©cessaire
            if (groupPositions[groupId]) {
                removeGroupChip(groupId, groupPositions[groupId]);
                updateStageCellStyle(groupPositions[groupId]);
            }
            groupPositions[groupId] = position;
            renderGroupChip(groupId, position);
            closeGroupPicker();
            updateStageCellStyle(position);
            updateSummary();
        }

        function removeGroupFromPosition(groupId) {
            const position = groupPositions[groupId];
            if (position) {
                removeGroupChip(groupId, position);
                delete groupPositions[groupId];
                updateStageCellStyle(position);
                updateSummary();
            }
        }

        function renderGroupChip(groupId, position) {
            const container = document.getElementById(`cell-${position}`);
            if (!container) return;
            // √âviter les doublons
            const existing = document.getElementById(`chip-${groupId}`);
            if (existing) existing.remove();

            const chip = document.createElement('div');
            chip.className = 'group-chip';
            chip.id = `chip-${groupId}`;
            // Couleur du chip : utiliser la couleur du groupe avec contraste auto
            const bgColor = groupColors[groupId] || '#888888';
            chip.style.backgroundColor = bgColor;
            chip.style.color = isLightColor(bgColor) ? '#000' : '#fff';

            chip.innerHTML = `${groupIcons[groupId] || ''} ${groupNames[groupId] || groupId}`;

            const removeBtn = document.createElement('span');
            removeBtn.className = 'chip-remove';
            removeBtn.textContent = ' ‚úï';
            removeBtn.onclick = (e) => { e.stopPropagation(); removeGroupFromPosition(groupId); };
            chip.appendChild(removeBtn);

            container.appendChild(chip);
        }

        function removeGroupChip(groupId) {
            const chip = document.getElementById(`chip-${groupId}`);
            if (chip) chip.remove();
        }

        function updateStageCellStyle(position) {
            const cell = document.querySelector(`.stage-cell[data-position="${position}"]`);
            if (!cell) return;
            const hasGroups = Object.values(groupPositions).includes(position);
            cell.classList.toggle('has-group', hasGroups);
        }

        // Retourne les groupIds qui ont au moins 1 checkbox coch√©e dans le tableau
        function getActiveGroups() {
            const active = new Set();
            document.querySelectorAll('#groupingTableBody input[type="checkbox"]:checked').forEach(cb => {
                active.add(cb.dataset.group);
            });
            return Array.from(active);
        }

        // D√©termine si une couleur hex est claire (pour choisir texte noir ou blanc)
        function isLightColor(hex) {
            const c = hex.replace('#', '');
            const r = parseInt(c.substr(0,2),16);
            const g = parseInt(c.substr(2,2),16);
            const b = parseInt(c.substr(4,2),16);
            return (r * 299 + g * 587 + b * 114) / 1000 > 128;
        }

        // ============================================================
        // G√âN√âRER ET OUVRIR STAGE PLAN
        // ============================================================

        // G√©n√©rer et ouvrir Stage Plan
        function generateAndOpenStagePlan() {
            const stageGroups = {};
            const tbody = document.getElementById('groupingTableBody');
            let hasErrors = false;

            // Parcourir toutes les lignes
            Array.from(tbody.rows).forEach(row => {
                const trackIndex = row.dataset.trackIndex;
                const track = patchList[trackIndex];

                const checkedBox = row.querySelector('input[type="checkbox"]:checked');
                if (checkedBox) {
                    const groupId = checkedBox.dataset.group;
                    // Lire la position depuis le tableau de sc√®ne (groupPositions)
                    const position = groupPositions[groupId];

                    if (!position) {
                        alert(`‚ö†Ô∏è Veuillez placer le groupe "${groupNames[groupId] || groupId}" sur le tableau de sc√®ne.`);
                        hasErrors = true;
                        return;
                    }

                    if (!stageGroups[groupId]) {
                        const auxNum = groupId.startsWith('retour_') ? parseInt(groupId.replace('retour_', '')) : null;
                        const retourEntry = returnsList.find(r => r.aux === auxNum);
                        stageGroups[groupId] = {
                            tracks: [],
                            position: position,
                            icon: groupIcons[groupId],
                            name: groupNames[groupId],
                            color: groupColors[groupId] || '#888888',
                            auxNum: retourEntry ? retourEntry.aux : null,
                            auxPair: retourEntry ? retourEntry.auxPair : null,
                            monitorType: retourEntry ? retourEntry.type : null
                        };
                    }

                    stageGroups[groupId].tracks.push(track);
                }
            });

            if (hasErrors) return;

            if (Object.keys(stageGroups).length === 0) {
                alert('‚ö†Ô∏è Veuillez assigner au moins une piste √† un groupe avant de g√©n√©rer le plan.');
                return;
            }
            
            // R√©cup√©rer les options
            const options = {
                generateReturns: document.getElementById('generateReturns').checked,
                generateDI: document.getElementById('generateDI').checked,
                generateAmpli: document.getElementById('generateAmpli').checked,
                generateMicrophones: document.getElementById('generateMicrophones').checked,
                generateCables: document.getElementById('generateCables').checked,
                autoScale: document.getElementById('autoScale').checked
            };
            
            // Pr√©parer les donn√©es pour Stage Plan
            const stageData = {
                groups: stageGroups,
                options: options,
                timestamp: new Date().toISOString(),
                source: 'disposition-scenique',
                version: '1.0'
            };
            
            // Sauvegarder dans localStorage
            localStorage.setItem('stageGroupsData', JSON.stringify(stageData));
            
            // Ouvrir Stage Plan
            window.location.href = 'Stage-Plan-V21-ModeGenerique (1).html';
        }

        // ============================================================
        // EXPORTS FICHE TECHNIQUE & PATCH LIST
        // ============================================================

        function exportFicheTechPDF() {
            alert('üí° Pour t√©l√©charger la fiche technique compl√®te en PDF, retournez sur la fiche technique et cliquez sur "T√©l√©charger PDF".');
        }

        function exportFicheTechPNG() {
            alert('üí° Pour t√©l√©charger la fiche technique compl√®te en PNG, retournez sur la fiche technique.');
        }

        function exportPatchListCSV() {
            const groupName = _getSceneGroupName();
            let csv = '\ufeff';
            csv += `PATCH LIST - ${groupName}\n\n`;
            csv += 'PATCH LIST FACE\n';
            csv += 'Canal,Instrument,Microphone,Pied\n';
            patchList.forEach(item => {
                csv += `${item.channel},"${item.instrument || ''}","${item.mic || ''}","${item.stand || ''}"\n`;
            });
            csv += '\n';
            csv += 'PATCH LIST RETOURS\n';
            csv += 'AUX,Destination,Type\n';
            returnsList.forEach(item => {
                const auxText = item.isStereo ? `AUX ${item.aux}-${item.auxPair}` : `AUX ${item.aux}`;
                csv += `"${auxText}","${item.destination || ''}","${item.type || ''}"\n`;
            });
            csv += `\nG√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} par FICHE TECH CREATOR v1.2\n`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `PatchList_${groupName.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportPatchListPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const groupName = _getSceneGroupName();

            doc.setFillColor(222, 173, 57);
            doc.rect(0, 0, 210, 42, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text(groupName, 105, 18, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text('PATCH LIST', 105, 33, { align: 'center' });

            function drawTableHeader(doc, y, cols) {
                doc.setFillColor(45, 45, 45);
                doc.rect(10, y - 5, 190, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                cols.forEach(col => doc.text(col.label, col.x, y));
                doc.setFont('helvetica', 'normal');
            }

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(13);
            doc.setFont('helvetica', 'bold');
            doc.text('PATCH LIST FACE', 20, 54);
            doc.setFont('helvetica', 'normal');

            const faceColumns = [
                { label: 'CH', x: 14 },
                { label: 'INSTRUMENT', x: 30 },
                { label: 'MICROPHONE', x: 90 },
                { label: 'PIED', x: 155 },
            ];

            let y = 64;
            drawTableHeader(doc, y, faceColumns);
            y += 9;
            doc.setFontSize(8);
            patchList.forEach((item, idx) => {
                if (y > 272) { doc.addPage(); y = 20; drawTableHeader(doc, y, faceColumns); y += 9; }
                const hex = item.color || '#888888';
                const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
                doc.setFillColor(r, g, b);
                doc.rect(10, y - 4, 3, 7, 'F');
                if (idx % 2 === 0) { doc.setFillColor(248,248,248); doc.rect(13, y-4, 187, 7, 'F'); }
                doc.setTextColor(0, 0, 0);
                doc.text(String(item.channel), 14, y);
                doc.text(doc.splitTextToSize(item.instrument || '', 55)[0], 30, y);
                doc.text(doc.splitTextToSize(item.mic || '', 60)[0], 90, y);
                doc.text(item.stand || '', 155, y);
                y += 7;
            });

            y += 10;
            if (y > 255) { doc.addPage(); y = 20; }
            doc.setFontSize(13); doc.setFont('helvetica', 'bold'); doc.setTextColor(0,0,0);
            doc.text('PATCH LIST RETOURS', 20, y);
            doc.setFont('helvetica', 'normal');
            y += 10;

            const retColumns = [
                { label: 'AUX', x: 14 },
                { label: 'DESTINATION', x: 45 },
                { label: 'TYPE', x: 145 },
            ];
            drawTableHeader(doc, y, retColumns);
            y += 9;
            doc.setFontSize(8);
            returnsList.forEach((item, idx) => {
                if (y > 272) { doc.addPage(); y = 20; drawTableHeader(doc, y, retColumns); y += 9; }
                const auxText = item.isStereo ? `AUX ${item.aux}-${item.auxPair}` : `AUX ${item.aux}`;
                const hex = item.color || '#888888';
                const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
                doc.setFillColor(r, g, b);
                doc.rect(10, y - 4, 3, 7, 'F');
                if (idx % 2 === 0) { doc.setFillColor(248,248,248); doc.rect(13, y-4, 187, 7, 'F'); }
                doc.setTextColor(0, 0, 0);
                doc.text(auxText, 14, y);
                doc.text(doc.splitTextToSize(item.destination || '', 95)[0], 45, y);
                doc.text(item.type || '', 145, y);
                y += 7;
            });

            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(7); doc.setTextColor(160,160,160);
                doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} ‚Äî ¬© 2025 Arnisound Tools ‚Äî page ${i}/${totalPages}`, 105, 292, { align: 'center' });
            }

            doc.save(`PatchList_${groupName.replace(/\s+/g, '_')}.pdf`);
        }

        // ============================================================
        // EXPORTS PLAN DE SC√àNE
        // ============================================================

        function _getSceneGroupName() {
            // Tenter de r√©cup√©rer le nom du groupe depuis le localStorage
            try {
                const fd = JSON.parse(localStorage.getItem('formData') || '{}');
                return fd.groupName || 'Plan_de_Scene';
            } catch(e) {
                return 'Plan_de_Scene';
            }
        }

        function exportScenePlanPNG() {
            const target = document.querySelector('.container');
            if (!target) return;
            html2canvas(target, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.download = `PlanScene_${_getSceneGroupName().replace(/\s+/g, '_')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                })
                .catch(() => alert('Erreur lors de la g√©n√©ration du PNG.'));
        }

        function exportScenePlanPDF() {
            const target = document.querySelector('.container');
            if (!target) return;
            html2canvas(target, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false })
                .then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                    const pdfW = pdf.internal.pageSize.getWidth();
                    const pdfH = pdf.internal.pageSize.getHeight();
                    const ratio = Math.min(pdfW / canvas.width, pdfH / canvas.height);
                    const imgW = canvas.width * ratio;
                    const imgH = canvas.height * ratio;
                    const offsetX = (pdfW - imgW) / 2;
                    const offsetY = (pdfH - imgH) / 2;
                    pdf.addImage(imgData, 'PNG', offsetX, offsetY, imgW, imgH);
                    pdf.save(`PlanScene_${_getSceneGroupName().replace(/\s+/g, '_')}.pdf`);
                })
                .catch(() => alert('Erreur lors de la g√©n√©ration du PDF.'));
        }

        // V√©rifier si un format d'export a √©t√© demand√© depuis la page principale
        (function checkExportSignal() {
            const fmt = localStorage.getItem('scenePlanExportFormat');
            if (fmt) {
                localStorage.removeItem('scenePlanExportFormat');
                // Mettre en √©vidence le bloc export
                const block = document.getElementById('exportSceneBlock');
                if (block) {
                    block.style.boxShadow = '0 0 0 3px #ffd700';
                    block.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            }
        })();
    </script>
</body>
</html>
