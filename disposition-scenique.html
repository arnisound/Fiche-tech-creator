<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disposition Sc√©nique - Arnisound Tools</title>
    
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                              ‚ïë
‚ïë                    DISPOSITION SC√âNIQUE v1.0                                 ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Copyright ¬© 2025 Th√©o Arnisound                                            ‚ïë
‚ïë  Tous droits r√©serv√©s                                                       ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Module de liaison Fiche Tech Creator ‚Üí Stage Plan                          ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #000000 0%, #ffffff 300%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #c19a3e 0%, #ffd700 100%);
            height: 100%;
            width: 100%;
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px 30px;
        }

        .info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #c19a3e;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .info-box h3 {
            color: #c19a3e;
            margin-bottom: 15px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #333;
        }

        .info-box li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .grouping-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #c19a3e;
        }

        .table-wrapper {
            overflow-x: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .grouping-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .grouping-table thead {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .grouping-table th {
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
            border: 1px solid #444;
            font-size: 14px;
        }

        .grouping-table td {
            padding: 12px 10px;
            border: 1px solid #ddd;
            text-align: center;
            background: white;
        }

        .grouping-table tbody tr:hover {
            background: #f8f9fa;
        }

        .grouping-table tbody tr.has-group {
            background: #fff3cd;
        }

        .channel-cell {
            background: #c19a3e;
            color: #000;
            font-weight: bold;
            font-size: 14px;
        }

        .instrument-cell {
            text-align: left;
            padding-left: 15px;
            font-weight: 500;
            color: #333;
        }

        .mic-cell {
            text-align: left;
            color: #666;
            font-size: 13px;
        }

        .checkbox-cell {
            padding: 5px;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #c19a3e;
        }

        .position-cell select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .position-cell select:focus {
            outline: none;
            border-color: #c19a3e;
            box-shadow: 0 0 0 2px rgba(193, 154, 62, 0.2);
        }

        .position-cell select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .options-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .option-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: #c19a3e;
            box-shadow: 0 2px 8px rgba(193, 154, 62, 0.2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .checkbox-label input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #c19a3e;
        }

        .option-description {
            margin: 10px 0 0 34px;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #c19a3e 0%, #ffd700 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(193, 154, 62, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-add-group {
            background: white;
            border: 2px solid #c19a3e;
            color: #c19a3e;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-add-group:hover {
            background: #c19a3e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 154, 62, 0.3);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .summary-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .summary-title {
            font-size: 20px;
            color: #2e7d32;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #c19a3e;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé≠ Disposition Sc√©nique</h1>
            <p>Organisez votre configuration sc√©nique avant de g√©n√©rer le plan</p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>

        <div class="content">
            <!-- Alerte si pas de donn√©es -->
            <div id="noDataAlert" class="alert alert-warning" style="display: none;">
                <strong>‚ö†Ô∏è Aucune donn√©e d√©tect√©e</strong><br>
                Veuillez d'abord compl√©ter le questionnaire dans <strong>Fiche Tech Creator</strong> pour g√©n√©rer votre patch list.
                <div style="margin-top: 15px;">
                    <a href="V1.2FINALfiche-tech-creator-avec-brevo.html" class="btn btn-secondary">‚Üê Retour √† Fiche Tech Creator</a>
                </div>
            </div>

            <!-- Contenu principal -->
            <div id="mainContent" style="display: none;">
                <!-- Instructions -->
                <div class="info-box">
                    <h3>üìã Comment √ßa fonctionne :</h3>
                    <ul>
                        <li><strong>√âtape 1 :</strong> Pour chaque piste, cochez le groupe correspondant (batterie, guitare, etc.)</li>
                        <li><strong>√âtape 2 :</strong> D√©finissez la position sc√©nique pour chaque piste group√©e</li>
                        <li><strong>√âtape 3 :</strong> Les pistes d'un m√™me groupe doivent avoir la m√™me position</li>
                        <li><strong>√âtape 4 :</strong> Configurez les options de g√©n√©ration automatique</li>
                        <li><strong>√âtape 5 :</strong> G√©n√©rez votre plan de sc√®ne avec des √©l√©ments g√©n√©riques positionn√©s automatiquement</li>
                    </ul>
                </div>

                <!-- R√©sum√© du patch -->
                <div id="summaryBox" class="summary-box" style="display: none;">
                    <div class="summary-title">üìä R√©sum√© de votre configuration</div>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalTracks">0</div>
                            <div class="stat-label">Pistes totales</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="assignedTracks">0</div>
                            <div class="stat-label">Pistes assign√©es</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="activeGroups">0</div>
                            <div class="stat-label">Groupes actifs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stageZones">0</div>
                            <div class="stat-label">Zones utilis√©es</div>
                        </div>
                    </div>
                </div>

                <!-- Tableau de groupement -->
                <div class="grouping-section">
                    <h2 class="section-title">üéº Groupement des pistes</h2>
                    
                    <div class="table-wrapper">
                        <table class="grouping-table">
                            <thead>
                                <tr id="tableHeader">
                                    <th style="width: 60px;">Canal</th>
                                    <th style="width: 250px;">Instrument</th>
                                    <th style="width: 200px;">Microphone</th>
                                    <th>ü•Å Batterie</th>
                                    <th>üé∏ Guitare</th>
                                    <th>üé∏ Basse</th>
                                    <th>üéπ Clavier</th>
                                    <th>üé§ Voix Lead</th>
                                    <th>üéµ Ch≈ìurs</th>
                                    <th style="width: 220px;">üìç Position Sc√®ne</th>
                                </tr>
                            </thead>
                            <tbody id="groupingTableBody">
                                <!-- Sera rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>

                    <button class="btn-add-group" onclick="addCustomGroup()">+ Ajouter un groupe personnalis√©</button>
                </div>

                <!-- Options de g√©n√©ration -->
                <div class="options-section">
                    <h2 class="section-title">‚öôÔ∏è Options de g√©n√©ration du plan</h2>
                    
                    <div class="options-grid">
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateReturns" checked>
                                <span>Retours de sc√®ne</span>
                            </label>
                            <p class="option-description">
                                G√©n√®re automatiquement des moniteurs floor pour chaque groupe de musiciens. 
                                Les retours seront positionn√©s devant chaque zone.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateDI" checked>
                                <span>Bo√Ætiers DI</span>
                            </label>
                            <p class="option-description">
                                Ajoute automatiquement les bo√Ætiers DI pour les instruments √©lectriques 
                                (basse, guitare, clavier).
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateAmpli">
                                <span>Amplificateurs</span>
                            </label>
                            <p class="option-description">
                                Affiche les amplificateurs guitare et basse sur le plan de sc√®ne 
                                avec leur emplacement approximatif.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateMicrophones" checked>
                                <span>Microphones</span>
                            </label>
                            <p class="option-description">
                                Place des symboles de microphones g√©n√©riques pour chaque piste 
                                selon le type d'instrument.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateCables">
                                <span>C√¢blage simplifi√©</span>
                            </label>
                            <p class="option-description">
                                Trace des lignes de c√¢blage simplifi√©es vers la r√©gie 
                                pour visualiser les connexions.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoScale" checked>
                                <span>Mise √† l'√©chelle auto</span>
                            </label>
                            <p class="option-description">
                                Ajuste automatiquement l'√©chelle du plan en fonction 
                                du nombre d'√©l√©ments et de leur disposition.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Boutons de navigation -->
                <div class="buttons">
                    <a href="V1.2FINALfiche-tech-creator-avec-brevo.html" class="btn btn-secondary">
                        ‚Üê Retour au questionnaire
                    </a>
                    <button class="btn btn-primary" onclick="generateAndOpenStagePlan()">
                        G√©n√©rer le plan de sc√®ne ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let patchList = [];
        let groupColumns = ['batterie', 'guitare', 'basse', 'clavier', 'voix', 'choeurs'];
        let groupIcons = {
            'batterie': 'ü•Å',
            'guitare': 'üé∏',
            'basse': 'üé∏',
            'clavier': 'üéπ',
            'voix': 'üé§',
            'choeurs': 'üéµ'
        };
        let groupNames = {
            'batterie': 'Batterie',
            'guitare': 'Guitare',
            'basse': 'Basse',
            'clavier': 'Clavier',
            'voix': 'Voix Lead',
            'choeurs': 'Ch≈ìurs'
        };

        // Charger les donn√©es au d√©marrage
        window.addEventListener('DOMContentLoaded', function() {
            loadPatchData();
        });

        // Charger les donn√©es du patch depuis localStorage
        function loadPatchData() {
            try {
                const storedData = localStorage.getItem('patchList');
                
                if (storedData && storedData !== 'null' && storedData !== '[]') {
                    patchList = JSON.parse(storedData);
                    
                    if (patchList && patchList.length > 0) {
                        document.getElementById('noDataAlert').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                        initializeTable();
                        updateSummary();
                    } else {
                        showNoDataAlert();
                    }
                } else {
                    showNoDataAlert();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                showNoDataAlert();
            }
        }

        // Afficher l'alerte "pas de donn√©es"
        function showNoDataAlert() {
            document.getElementById('noDataAlert').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        // Initialiser le tableau
        function initializeTable() {
            const tbody = document.getElementById('groupingTableBody');
            tbody.innerHTML = '';

            patchList.forEach((track, index) => {
                const row = document.createElement('tr');
                row.dataset.trackIndex = index;

                // Canal
                const channelCell = document.createElement('td');
                channelCell.className = 'channel-cell';
                channelCell.textContent = track.channel;
                row.appendChild(channelCell);

                // Instrument
                const instrumentCell = document.createElement('td');
                instrumentCell.className = 'instrument-cell';
                instrumentCell.textContent = track.instrument || track.name || '-';
                row.appendChild(instrumentCell);

                // Microphone
                const micCell = document.createElement('td');
                micCell.className = 'mic-cell';
                micCell.textContent = track.mic || track.microphone || '-';
                row.appendChild(micCell);

                // Checkboxes pour chaque groupe
                groupColumns.forEach(groupId => {
                    const checkCell = document.createElement('td');
                    checkCell.className = 'checkbox-cell';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.trackIndex = index;
                    checkbox.dataset.group = groupId;
                    checkbox.addEventListener('change', handleGroupChange);
                    
                    checkCell.appendChild(checkbox);
                    row.appendChild(checkCell);
                });

                // Position sc√®ne
                const positionCell = document.createElement('td');
                positionCell.className = 'position-cell';
                
                const select = document.createElement('select');
                select.dataset.trackIndex = index;
                select.disabled = true;
                select.addEventListener('change', updateSummary);
                select.innerHTML = `
                    <option value="">-- S√©lectionner --</option>
                    <option value="back-left">Fond gauche (jardin)</option>
                    <option value="back-center">Fond centre</option>
                    <option value="back-right">Fond droite (cour)</option>
                    <option value="mid-left">Milieu gauche</option>
                    <option value="mid-center">Milieu centre</option>
                    <option value="mid-right">Milieu droite</option>
                    <option value="front-left">Avant gauche</option>
                    <option value="front-center">Avant centre</option>
                    <option value="front-right">Avant droite</option>
                `;
                
                positionCell.appendChild(select);
                row.appendChild(positionCell);

                tbody.appendChild(row);
            });
        }

        // G√©rer le changement de checkbox
        function handleGroupChange(e) {
            const checkbox = e.target;
            const trackIndex = checkbox.dataset.trackIndex;
            const groupId = checkbox.dataset.group;
            const row = checkbox.closest('tr');
            const positionSelect = row.querySelector('.position-cell select');

            if (checkbox.checked) {
                // D√©cocher les autres checkboxes de cette ligne
                row.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb !== checkbox) {
                        cb.checked = false;
                    }
                });
                
                // Activer le select de position
                positionSelect.disabled = false;
                row.classList.add('has-group');
            } else {
                // D√©sactiver le select de position
                positionSelect.disabled = true;
                positionSelect.value = '';
                row.classList.remove('has-group');
            }
            
            updateSummary();
        }

        // Mettre √† jour le r√©sum√©
        function updateSummary() {
            const tbody = document.getElementById('groupingTableBody');
            const rows = Array.from(tbody.rows);
            
            const totalTracks = patchList.length;
            let assignedTracks = 0;
            const activeGroupsSet = new Set();
            const stageZonesSet = new Set();
            
            rows.forEach(row => {
                const checkedBox = row.querySelector('input[type="checkbox"]:checked');
                if (checkedBox) {
                    assignedTracks++;
                    activeGroupsSet.add(checkedBox.dataset.group);
                    
                    const position = row.querySelector('.position-cell select').value;
                    if (position) {
                        stageZonesSet.add(position);
                    }
                }
            });
            
            document.getElementById('totalTracks').textContent = totalTracks;
            document.getElementById('assignedTracks').textContent = assignedTracks;
            document.getElementById('activeGroups').textContent = activeGroupsSet.size;
            document.getElementById('stageZones').textContent = stageZonesSet.size;
            
            // Afficher le r√©sum√© si des pistes sont assign√©es
            document.getElementById('summaryBox').style.display = assignedTracks > 0 ? 'block' : 'none';
        }

        // Ajouter un groupe personnalis√©
        function addCustomGroup() {
            const groupName = prompt('Nom du groupe personnalis√©:');
            if (!groupName) return;
            
            const groupId = groupName.toLowerCase().replace(/\s+/g, '-');
            if (groupColumns.includes(groupId)) {
                alert('Ce groupe existe d√©j√†!');
                return;
            }
            
            const icon = prompt('Emoji pour le groupe (optionnel):', 'üéµ');
            
            groupColumns.push(groupId);
            groupIcons[groupId] = icon || 'üéµ';
            groupNames[groupId] = groupName;
            
            // Ajouter la colonne dans le header
            const thead = document.querySelector('.grouping-table thead tr');
            const newTh = document.createElement('th');
            newTh.textContent = `${icon || 'üéµ'} ${groupName}`;
            thead.insertBefore(newTh, thead.lastElementChild);
            
            // Ajouter la checkbox dans chaque ligne
            const tbody = document.getElementById('groupingTableBody');
            Array.from(tbody.rows).forEach((row, index) => {
                const checkCell = document.createElement('td');
                checkCell.className = 'checkbox-cell';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.trackIndex = index;
                checkbox.dataset.group = groupId;
                checkbox.addEventListener('change', handleGroupChange);
                
                checkCell.appendChild(checkbox);
                row.insertBefore(checkCell, row.lastElementChild);
            });
        }

        // G√©n√©rer et ouvrir Stage Plan
        function generateAndOpenStagePlan() {
            const stageGroups = {};
            const tbody = document.getElementById('groupingTableBody');
            let hasErrors = false;
            
            // Parcourir toutes les lignes
            Array.from(tbody.rows).forEach(row => {
                const trackIndex = row.dataset.trackIndex;
                const track = patchList[trackIndex];
                
                const checkedBox = row.querySelector('input[type="checkbox"]:checked');
                if (checkedBox) {
                    const groupId = checkedBox.dataset.group;
                    const position = row.querySelector('.position-cell select').value;
                    
                    if (!position) {
                        alert(`‚ö†Ô∏è Veuillez d√©finir une position pour "${track.instrument}"`);
                        hasErrors = true;
                        return;
                    }
                    
                    if (!stageGroups[groupId]) {
                        stageGroups[groupId] = {
                            tracks: [],
                            position: position,
                            icon: groupIcons[groupId],
                            name: groupNames[groupId]
                        };
                    } else if (stageGroups[groupId].position !== position) {
                        alert(`‚ö†Ô∏è Toutes les pistes du groupe "${groupNames[groupId]}" doivent avoir la m√™me position!`);
                        hasErrors = true;
                        return;
                    }
                    
                    stageGroups[groupId].tracks.push(track);
                }
            });
            
            if (hasErrors) return;
            
            if (Object.keys(stageGroups).length === 0) {
                alert('‚ö†Ô∏è Veuillez assigner au moins une piste √† un groupe avant de g√©n√©rer le plan.');
                return;
            }
            
            // R√©cup√©rer les options
            const options = {
                generateReturns: document.getElementById('generateReturns').checked,
                generateDI: document.getElementById('generateDI').checked,
                generateAmpli: document.getElementById('generateAmpli').checked,
                generateMicrophones: document.getElementById('generateMicrophones').checked,
                generateCables: document.getElementById('generateCables').checked,
                autoScale: document.getElementById('autoScale').checked
            };
            
            // Pr√©parer les donn√©es pour Stage Plan
            const stageData = {
                groups: stageGroups,
                options: options,
                timestamp: new Date().toISOString(),
                source: 'disposition-scenique',
                version: '1.0'
            };
            
            // Sauvegarder dans localStorage
            localStorage.setItem('stageGroupsData', JSON.stringify(stageData));
            
            // Ouvrir Stage Plan
            window.location.href = 'stage-plan.html';
        }
    </script>
</body>
</html>
