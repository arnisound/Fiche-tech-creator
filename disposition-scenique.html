<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disposition Sc√©nique - Arnisound Tools</title>
    
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                              ‚ïë
‚ïë                    DISPOSITION SC√âNIQUE v1.0                                 ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Copyright ¬© 2025 Th√©o Arnisound                                            ‚ïë
‚ïë  Tous droits r√©serv√©s                                                       ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Module de liaison Fiche Tech Creator ‚Üí Stage Plan                          ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #000000 0%, #ffffff 300%);
            color: white;
            padding: 45px 45px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header svg {
            max-width: 100%;
            height: auto;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #c19a3e 0%, #ffd700 100%);
            height: 100%;
            width: 100%;
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px 30px;
        }

        .info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #c19a3e;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .info-box h3 {
            color: #c19a3e;
            margin-bottom: 15px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #333;
        }

        .info-box li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #c19a3e;
        }

        /* Grille des musiciens */
        .musicians-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .musician-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .musician-card:hover {
            border-color: #c19a3e;
            box-shadow: 0 4px 12px rgba(193, 154, 62, 0.2);
        }

        .musician-card-header {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .musician-card-header span {
            color: #ffd700;
            font-weight: bold;
            font-size: 14px;
        }

        .musician-card-body {
            padding: 15px;
        }

        .musician-card .field-group {
            margin-bottom: 12px;
        }

        .musician-card .field-group:last-child {
            margin-bottom: 0;
        }

        .musician-card label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .musician-card input[type="text"],
        .musician-card select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .musician-card input[type="text"]:focus,
        .musician-card select:focus {
            outline: none;
            border-color: #c19a3e;
            box-shadow: 0 0 0 3px rgba(193, 154, 62, 0.15);
        }

        .btn-delete-musician {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-delete-musician:hover {
            background: #ff3838;
            transform: scale(1.05);
        }

        .musician-track-count {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .musician-track-count strong {
            color: #c19a3e;
        }

        /* Tableau d'attribution des pistes */
        .track-table-wrapper {
            overflow-x: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .track-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .track-table thead {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .track-table th {
            padding: 14px 12px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
            border: 1px solid #444;
            font-size: 14px;
        }

        .track-table td {
            padding: 10px 12px;
            border: 1px solid #ddd;
            text-align: center;
            background: white;
        }

        .track-table tbody tr:hover {
            background: #f8f9fa;
        }

        .track-table tbody tr.assigned {
            background: #fff3cd;
        }

        .track-table .channel-cell {
            background: #c19a3e;
            color: #000;
            font-weight: bold;
            font-size: 14px;
            width: 60px;
        }

        .track-table .instrument-cell {
            text-align: left;
            padding-left: 15px;
            font-weight: 500;
            color: #333;
        }

        .track-table .mic-cell {
            text-align: left;
            color: #666;
            font-size: 13px;
        }

        .track-table .assign-cell select {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px 10px;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            min-width: 180px;
            transition: all 0.3s ease;
        }

        .track-table .assign-cell select:focus {
            outline: none;
            border-color: #c19a3e;
            box-shadow: 0 0 0 2px rgba(193, 154, 62, 0.2);
        }

        .btn-add-musician {
            background: white;
            border: 2px solid #c19a3e;
            color: #c19a3e;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add-musician:hover {
            background: #c19a3e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 154, 62, 0.3);
        }

        .options-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .option-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: #c19a3e;
            box-shadow: 0 2px 8px rgba(193, 154, 62, 0.2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .checkbox-label input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #c19a3e;
        }

        .option-description {
            margin: 10px 0 0 34px;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #c19a3e 0%, #ffd700 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(193, 154, 62, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .summary-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .summary-title {
            font-size: 20px;
            color: #2e7d32;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #c19a3e;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <svg width="1000" height="200" viewBox="0 0 1600 320" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                    <!-- Cercle blanc -->
                    <circle cx="400" cy="160" r="140" fill="none" stroke="#FFFFFF" stroke-width="12"/>

                    <!-- Texte DISPOSITION -->
                    <text x="400" y="140"
                          fill="#FFFFFF"
                          font-family="Arial, Helvetica, sans-serif"
                          font-weight="bold"
                          font-size="30"
                          text-anchor="middle"
                          letter-spacing="2">DISPOSITION</text>

                    <!-- Texte SC√âNIQUE -->
                    <text x="400" y="185"
                          fill="#FFFFFF"
                          font-family="Arial, Helvetica, sans-serif"
                          font-weight="bold"
                          font-size="36"
                          text-anchor="middle"
                          letter-spacing="3">SC√âNIQUE</text>

                    <!-- Forme d'onde dor√©e -->
                    <path d="M 330 250
                             C 338 250, 343 247, 348 243
                             C 353 239, 358 247, 363 250
                             C 368 253, 373 254, 378 253
                             C 383 252, 388 243, 396 237
                             C 404 231, 409 237, 414 243
                             C 419 249, 424 253, 429 254
                             C 434 255, 439 254, 444 253
                             C 449 252, 454 250, 459 250.5
                             C 464 251, 466.5 251.5, 469 252"
                          fill="none"
                          stroke="#C19A3E"
                          stroke-width="4"
                          stroke-linecap="round"
                          stroke-linejoin="round"/>

                    <!-- Groupe texte ARNISOUND TOOLS -->
                    <g transform="translate(1050, 0)">
                        <!-- Texte ARNISOUND -->
                        <text x="0" y="100"
                              fill="#FFFFFF"
                              font-family="Arial, Helvetica, sans-serif"
                              font-weight="bold"
                              font-size="38"
                              text-anchor="middle"
                              letter-spacing="2">ARNISOUND</text>

                        <!-- Texte TOOLS -->
                        <text x="0" y="145"
                              fill="#FFFFFF"
                              font-family="Arial, Helvetica, sans-serif"
                              font-weight="bold"
                              font-size="38"
                              text-anchor="middle"
                              letter-spacing="3">TOOLS</text>

                        <!-- Texte LIVE & AV -->
                        <text x="0" y="190"
                              fill="#FFFFFF"
                              font-family="Arial, Helvetica, sans-serif"
                              font-weight="bold"
                              font-size="38"
                              text-anchor="middle"
                              letter-spacing="3">LIVE &amp; AV</text>

                        <!-- Texte APP -->
                        <text x="0" y="235"
                              fill="#FFFFFF"
                              font-family="Arial, Helvetica, sans-serif"
                              font-weight="bold"
                              font-size="38"
                              text-anchor="middle"
                              letter-spacing="3">APP</text>
                    </g>
                </svg>
                <p style="color: white; font-size: 1.1em; margin-top: 15px; margin-bottom: 0; opacity: 0.95; text-align: center;">Organisez votre configuration sc√©nique avant de g√©n√©rer le plan</p>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>

        <div class="content">
            <!-- Alerte si pas de donn√©es -->
            <div id="noDataAlert" class="alert alert-warning" style="display: none;">
                <strong>‚ö†Ô∏è Aucune donn√©e d√©tect√©e</strong><br>
                Veuillez d'abord compl√©ter le questionnaire dans <strong>Fiche Tech Creator</strong> pour g√©n√©rer votre patch list.
                <div style="margin-top: 15px;">
                    <a href="fiche-tech-creator-v2.html" class="btn btn-secondary">‚Üê Retour √† Fiche Tech Creator</a>
                </div>
            </div>

            <!-- Contenu principal -->
            <div id="mainContent" style="display: none;">
                <!-- Instructions -->
                <div class="info-box">
                    <h3>üìã Comment √ßa fonctionne :</h3>
                    <ul>
                        <li><strong>√âtape 1 :</strong> Ajoutez vos musiciens et d√©finissez leur position sur sc√®ne (1 musicien = 1 retour)</li>
                        <li><strong>√âtape 2 :</strong> Assignez chaque piste audio au musicien correspondant</li>
                        <li><strong>√âtape 3 :</strong> Configurez les options de g√©n√©ration automatique</li>
                        <li><strong>√âtape 4 :</strong> G√©n√©rez votre plan de sc√®ne</li>
                    </ul>
                </div>

                <!-- R√©sum√© -->
                <div id="summaryBox" class="summary-box" style="display: none;">
                    <div class="summary-title">üìä R√©sum√© de votre configuration</div>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalTracks">0</div>
                            <div class="stat-label">Pistes totales</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="assignedTracks">0</div>
                            <div class="stat-label">Pistes assign√©es</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalMusicians">0</div>
                            <div class="stat-label">Musiciens (retours)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stageZones">0</div>
                            <div class="stat-label">Zones utilis√©es</div>
                        </div>
                    </div>
                </div>

                <!-- Section Musiciens -->
                <div class="section">
                    <h2 class="section-title">üé§ Musiciens &amp; Positions</h2>

                    <div class="musicians-grid" id="musiciansGrid">
                        <!-- Rempli dynamiquement -->
                    </div>

                    <button class="btn-add-musician" onclick="addMusician()">+ Ajouter un musicien</button>
                </div>

                <!-- Section Attribution des pistes -->
                <div class="section">
                    <h2 class="section-title">üéº Attribution des pistes</h2>

                    <div class="track-table-wrapper">
                        <table class="track-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Canal</th>
                                    <th>Instrument</th>
                                    <th>Microphone</th>
                                    <th style="width: 220px;">Musicien (retour)</th>
                                </tr>
                            </thead>
                            <tbody id="trackTableBody">
                                <!-- Rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Options de g√©n√©ration -->
                <div class="options-section">
                    <h2 class="section-title">‚öôÔ∏è Options de g√©n√©ration du plan</h2>
                    
                    <div class="options-grid">
                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateReturns" checked>
                                <span>Retours de sc√®ne</span>
                            </label>
                            <p class="option-description">
                                G√©n√®re automatiquement des moniteurs floor pour chaque groupe de musiciens. 
                                Les retours seront positionn√©s devant chaque zone.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateDI" checked>
                                <span>Bo√Ætiers DI</span>
                            </label>
                            <p class="option-description">
                                Ajoute automatiquement les bo√Ætiers DI pour les instruments √©lectriques 
                                (basse, guitare, clavier).
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateAmpli">
                                <span>Amplificateurs</span>
                            </label>
                            <p class="option-description">
                                Affiche les amplificateurs guitare et basse sur le plan de sc√®ne 
                                avec leur emplacement approximatif.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateMicrophones" checked>
                                <span>Microphones</span>
                            </label>
                            <p class="option-description">
                                Place des symboles de microphones g√©n√©riques pour chaque piste 
                                selon le type d'instrument.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="generateCables">
                                <span>C√¢blage simplifi√©</span>
                            </label>
                            <p class="option-description">
                                Trace des lignes de c√¢blage simplifi√©es vers la r√©gie 
                                pour visualiser les connexions.
                            </p>
                        </div>

                        <div class="option-card">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoScale" checked>
                                <span>Mise √† l'√©chelle auto</span>
                            </label>
                            <p class="option-description">
                                Ajuste automatiquement l'√©chelle du plan en fonction 
                                du nombre d'√©l√©ments et de leur disposition.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Boutons de navigation -->
                <div class="buttons">
                    <a href="fiche-tech-creator-v2.html" class="btn btn-secondary">
                        ‚Üê Retour au questionnaire
                    </a>
                    <button class="btn btn-primary" onclick="generateAndOpenStagePlan()">
                        G√©n√©rer le plan de sc√®ne ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer de copyright -->
    <footer style="background: #000000;
                   color: #666;
                   text-align: center;
                   padding: 20px 20px;
                   font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                   font-size: 0.5em;">
        <div style="max-width: 800px; margin: 0 auto;">
            <p style="margin: 5px 0;">
                <strong>Disposition Sc√©nique v1.0</strong>
            </p>
            <p style="margin: 5px 0;">
                ¬© 2025 Th√©o Arnissolle - Tous droits r√©serv√©s
            </p>
            <p style="margin: 5px 0;">
                <a href="mailto:arnisound.tools@gmail.com"
                   style="color: #c19a3e; text-decoration: none;">
                    arnisound.tools@gmail.com
                </a>
            </p>
            <p style="margin: 10px 0 5px 0; font-size: 0.85em;">
                Usage personnel et non-commercial uniquement ‚Ä¢
                <a href="LICENSE.txt" style="color: #c19a3e; text-decoration: none;">Voir la licence</a>
            </p>
        </div>
    </footer>

    <script>
        // Variables globales
        let patchList = [];
        let musicians = [];
        let trackAssignments = {}; // trackIndex -> musicianId
        let nextMusicianId = 1;

        // Charger les donn√©es au d√©marrage
        window.addEventListener('DOMContentLoaded', function() {
            loadPatchData();
        });

        // Charger les donn√©es du patch depuis localStorage
        function loadPatchData() {
            try {
                const storedData = localStorage.getItem('patchList');

                if (storedData && storedData !== 'null' && storedData !== '[]') {
                    patchList = JSON.parse(storedData);

                    if (patchList && patchList.length > 0) {
                        document.getElementById('noDataAlert').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                        renderTrackTable();
                        updateSummary();
                    } else {
                        showNoDataAlert();
                    }
                } else {
                    showNoDataAlert();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                showNoDataAlert();
            }
        }

        // Afficher l'alerte "pas de donn√©es"
        function showNoDataAlert() {
            document.getElementById('noDataAlert').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        // Ajouter un musicien
        function addMusician() {
            const musician = {
                id: nextMusicianId++,
                name: '',
                position: ''
            };
            musicians.push(musician);
            renderMusicians();
            renderTrackDropdowns();
            updateSummary();
        }

        // Supprimer un musicien
        function removeMusician(musicianId) {
            musicians = musicians.filter(m => m.id !== musicianId);
            // D√©sassigner les pistes de ce musicien
            Object.keys(trackAssignments).forEach(key => {
                if (trackAssignments[key] === musicianId) {
                    delete trackAssignments[key];
                }
            });
            renderMusicians();
            renderTrackDropdowns();
            updateTrackRowStyles();
            updateSummary();
        }

        // Mettre √† jour le nom d'un musicien
        function updateMusicianName(musicianId, name) {
            const musician = musicians.find(m => m.id === musicianId);
            if (musician) {
                musician.name = name;
                renderTrackDropdowns();
                updateMusicianTrackCounts();
            }
        }

        // Mettre √† jour la position d'un musicien
        function updateMusicianPosition(musicianId, position) {
            const musician = musicians.find(m => m.id === musicianId);
            if (musician) {
                musician.position = position;
                updateSummary();
            }
        }

        // Rendre les cartes musiciens
        function renderMusicians() {
            const grid = document.getElementById('musiciansGrid');
            grid.innerHTML = '';

            musicians.forEach((musician, index) => {
                const card = document.createElement('div');
                card.className = 'musician-card';
                card.innerHTML = `
                    <div class="musician-card-header">
                        <span>Retour ${index + 1}</span>
                        <button class="btn-delete-musician" onclick="removeMusician(${musician.id})">Supprimer</button>
                    </div>
                    <div class="musician-card-body">
                        <div class="field-group">
                            <label>Nom du musicien / instrument</label>
                            <input type="text"
                                   value="${musician.name}"
                                   placeholder="Ex: Batteur, Guitariste 1, Chanteur..."
                                   oninput="updateMusicianName(${musician.id}, this.value)">
                        </div>
                        <div class="field-group">
                            <label>Position sur sc√®ne</label>
                            <select onchange="updateMusicianPosition(${musician.id}, this.value)">
                                <option value=""${musician.position === '' ? ' selected' : ''}>-- S√©lectionner --</option>
                                <option value="back-left"${musician.position === 'back-left' ? ' selected' : ''}>Fond gauche (jardin)</option>
                                <option value="back-center"${musician.position === 'back-center' ? ' selected' : ''}>Fond centre</option>
                                <option value="back-right"${musician.position === 'back-right' ? ' selected' : ''}>Fond droite (cour)</option>
                                <option value="mid-left"${musician.position === 'mid-left' ? ' selected' : ''}>Milieu gauche</option>
                                <option value="mid-center"${musician.position === 'mid-center' ? ' selected' : ''}>Milieu centre</option>
                                <option value="mid-right"${musician.position === 'mid-right' ? ' selected' : ''}>Milieu droite</option>
                                <option value="front-left"${musician.position === 'front-left' ? ' selected' : ''}>Avant gauche</option>
                                <option value="front-center"${musician.position === 'front-center' ? ' selected' : ''}>Avant centre</option>
                                <option value="front-right"${musician.position === 'front-right' ? ' selected' : ''}>Avant droite</option>
                            </select>
                        </div>
                        <div class="musician-track-count" id="trackCount-${musician.id}">
                            <strong>0</strong> piste(s) assign√©e(s)
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Rendre le tableau des pistes
        function renderTrackTable() {
            const tbody = document.getElementById('trackTableBody');
            tbody.innerHTML = '';

            patchList.forEach((track, index) => {
                const row = document.createElement('tr');
                row.dataset.trackIndex = index;

                // Canal
                const channelCell = document.createElement('td');
                channelCell.className = 'channel-cell';
                channelCell.textContent = track.channel;
                row.appendChild(channelCell);

                // Instrument
                const instrumentCell = document.createElement('td');
                instrumentCell.className = 'instrument-cell';
                instrumentCell.textContent = track.instrument || track.name || '-';
                row.appendChild(instrumentCell);

                // Microphone
                const micCell = document.createElement('td');
                micCell.className = 'mic-cell';
                micCell.textContent = track.mic || track.microphone || '-';
                row.appendChild(micCell);

                // Select musicien
                const assignCell = document.createElement('td');
                assignCell.className = 'assign-cell';

                const select = document.createElement('select');
                select.dataset.trackIndex = index;
                select.addEventListener('change', function() {
                    handleTrackAssignment(index, this.value);
                });
                select.innerHTML = buildMusicianOptions(index);

                assignCell.appendChild(select);
                row.appendChild(assignCell);

                tbody.appendChild(row);
            });
        }

        // Construire les options du dropdown musicien
        function buildMusicianOptions(trackIndex) {
            const currentAssignment = trackAssignments[trackIndex] || '';
            let html = `<option value="">-- Non assign√© --</option>`;
            musicians.forEach((m, idx) => {
                const label = m.name ? m.name : `Retour ${idx + 1}`;
                const selected = currentAssignment == m.id ? ' selected' : '';
                html += `<option value="${m.id}"${selected}>${label}</option>`;
            });
            return html;
        }

        // Mettre √† jour les dropdowns des pistes (quand les musiciens changent)
        function renderTrackDropdowns() {
            const selects = document.querySelectorAll('#trackTableBody .assign-cell select');
            selects.forEach(select => {
                const trackIndex = parseInt(select.dataset.trackIndex);
                select.innerHTML = buildMusicianOptions(trackIndex);
            });
        }

        // G√©rer l'assignation d'une piste
        function handleTrackAssignment(trackIndex, musicianId) {
            if (musicianId) {
                trackAssignments[trackIndex] = parseInt(musicianId);
            } else {
                delete trackAssignments[trackIndex];
            }
            updateTrackRowStyles();
            updateMusicianTrackCounts();
            updateSummary();
        }

        // Mettre √† jour le style des lignes assign√©es
        function updateTrackRowStyles() {
            const rows = document.querySelectorAll('#trackTableBody tr');
            rows.forEach(row => {
                const trackIndex = parseInt(row.dataset.trackIndex);
                if (trackAssignments[trackIndex]) {
                    row.classList.add('assigned');
                } else {
                    row.classList.remove('assigned');
                }
            });
        }

        // Mettre √† jour les compteurs de pistes par musicien
        function updateMusicianTrackCounts() {
            musicians.forEach(m => {
                const count = Object.values(trackAssignments).filter(id => id === m.id).length;
                const el = document.getElementById(`trackCount-${m.id}`);
                if (el) {
                    el.innerHTML = `<strong>${count}</strong> piste(s) assign√©e(s)`;
                }
            });
        }

        // Mettre √† jour le r√©sum√©
        function updateSummary() {
            const totalTracks = patchList.length;
            const assignedCount = Object.keys(trackAssignments).length;
            const musiciansWithPosition = musicians.filter(m => m.position).length;
            const zonesSet = new Set(musicians.filter(m => m.position).map(m => m.position));

            document.getElementById('totalTracks').textContent = totalTracks;
            document.getElementById('assignedTracks').textContent = assignedCount;
            document.getElementById('totalMusicians').textContent = musicians.length;
            document.getElementById('stageZones').textContent = zonesSet.size;

            document.getElementById('summaryBox').style.display =
                (musicians.length > 0 || assignedCount > 0) ? 'block' : 'none';
        }

        // G√©n√©rer et ouvrir Stage Plan
        function generateAndOpenStagePlan() {
            // Validation : au moins un musicien
            if (musicians.length === 0) {
                alert('Veuillez ajouter au moins un musicien avant de g√©n√©rer le plan.');
                return;
            }

            // Validation : chaque musicien doit avoir un nom et une position
            for (let i = 0; i < musicians.length; i++) {
                const m = musicians[i];
                if (!m.name.trim()) {
                    alert(`Veuillez donner un nom au musicien "Retour ${i + 1}".`);
                    return;
                }
                if (!m.position) {
                    alert(`Veuillez d√©finir une position pour "${m.name}".`);
                    return;
                }
            }

            // Construire les groupes par musicien
            const stageGroups = {};
            musicians.forEach((m, idx) => {
                const groupId = 'musician-' + m.id;
                const assignedTracks = [];

                Object.keys(trackAssignments).forEach(trackIdx => {
                    if (trackAssignments[trackIdx] === m.id) {
                        assignedTracks.push(patchList[parseInt(trackIdx)]);
                    }
                });

                stageGroups[groupId] = {
                    tracks: assignedTracks,
                    position: m.position,
                    name: m.name,
                    returnIndex: idx + 1
                };
            });

            // R√©cup√©rer les options
            const options = {
                generateReturns: document.getElementById('generateReturns').checked,
                generateDI: document.getElementById('generateDI').checked,
                generateAmpli: document.getElementById('generateAmpli').checked,
                generateMicrophones: document.getElementById('generateMicrophones').checked,
                generateCables: document.getElementById('generateCables').checked,
                autoScale: document.getElementById('autoScale').checked
            };

            // Pr√©parer les donn√©es pour Stage Plan
            const stageData = {
                groups: stageGroups,
                musicians: musicians,
                options: options,
                timestamp: new Date().toISOString(),
                source: 'disposition-scenique',
                version: '2.0'
            };

            // Sauvegarder dans localStorage
            localStorage.setItem('stageGroupsData', JSON.stringify(stageData));

            // Ouvrir Stage Plan
            window.location.href = 'stage-plan.html';
        }
    </script>
</body>
</html>
